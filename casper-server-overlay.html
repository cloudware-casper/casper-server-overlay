<!--
  - Copyright (c) 2017 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-server-overlay.
  -
  - casper-server-overlay is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-server-overlay  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-server-overlay.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">

<dom-module id="casper-server-overlay">
  <template>
    <style>

      :host {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: black;
        width: 100%;
        height: 100vh;
        opacity: 0;
        transition: opacity 3s;
        z-index: 8000;
        fill: white;
      }

      .spinner {
        position: relative;
        width: 250px;
        height: 250px;
      }

      svg {
        position: absolute;
        top: 50px;
        left: 50px;
      }

      #image {
        position: absolute;
        width: 250px;
        height: 250px;
        top: 0;
        left: 0;
      }

      p {
        text-align: center;
        color: #D8D8D8;
        font-size: 1.5em;
        line-height: 1.5em;
      }
    </style>
    <div class="spinner">
      <img id="image" alt="[[description]]">
      <svg id="spinner" width="150px" height="150px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" >
        <g transform="rotate(0 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.9166666666666666s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(30 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.8333333333333334s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(60 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(90 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.6666666666666666s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(120 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.5833333333333334s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(150 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.5s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(180 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.4166666666666667s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(210 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.3333333333333333s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(240 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.25s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(270 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.16666666666666666s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(300 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.08333333333333333s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(330 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="0s" repeatCount="indefinite"/>
          </rect>
        </g>
      </svg>
    </div>
    <p>[[description]]</p>
  </template>

  <script>
    /**
     * `casper-server-overlay`
     * Modal overlay that blocks the UI during critical server interactions
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperServerOverlay extends Polymer.mixinBehaviors([Polymer.IronOverlayBehavior], Polymer.Element) {
      static get is () {
        return 'casper-server-overlay';
      }

      static get properties () {
        return {
          socket: Object,
          description: String,
          icon: Object,
          visible: {
            type: Boolean,
            observer: '_updateVisible'
          }
        };
      }

      ready () {
        super.ready();
        this.noCancelOnEscKey = true;
        this._visibilityTimer = undefined;
        this._disconnected = false;
        this._connecting = false;
        this.$.spinner.style.display = 'none';

        this._boundOnCasperShowOverlay  = this._onCasperShowOverlay.bind(this);
        this._boundOnHideOverlay        = this._onHideOverlay.bind(this);
        this._boundOnCasperDisconnected = this._onCasperDisconnected.bind(this);
        this._boundOnCasperSignedIn     = this._onCasperSignedIn.bind(this);
        this._boundOnCasperSignedIn     = this._onCasperSignedIn.bind(this);
        this._boundCloseByUser          = this._onCloseByUser.bind(this);

        window.addEventListener('casper-show-overlay'   , this._boundOnCasperShowOverlay);
        window.addEventListener('casper-dismiss-overlay', this._boundOnHideOverlay);
        window.addEventListener('casper-disconnected'   , this._boundOnCasperDisconnected);
        window.addEventListener('casper-signed-in'      , this._boundOnCasperSignedIn);
        document.addEventListener('keydown', this._boundCloseByUser);
        
        this.addEventListener('mousemove', this._moveHandler);
        this.addEventListener('mouseup'  , this._mouseUpHandler);
      }

      connectedCallback () {
        super.connectedCallback();
      }

      disconnectedCallback () {
        super.disconnectedCallback();
        if ( this._visibilityTimer ) {
          clearTimeout(this._visibilityTimer);
          this._visibilityTimer = undefined;
        }
        window.removeEventListener('casper-show-overlay'   , this._boundOnCasperShowOverlay);
        window.removeEventListener('casper-dismiss-overlay', this._boundOnHideOverlay);
        window.removeEventListener('casper-disconnected'   , this._boundOnCasperDisconnected);
        window.removeEventListener('casper-signed-in'      , this._boundOnCasperSignedIn);
        document.removeEventListener('keydown', this._boundCloseByUser);
      }

      _onHideOverlay (event) {
        this.visible = false;
      }

      _onCasperSignedIn (event) {
        this._disconnected = false;
        this._connecting = false;
        this.visible = false;
      }

      _onCasperDisconnected (event) {
        this._disconnected = true;
        this._connecting = false;
        this._onCasperShowOverlay(event);
      }

      _onCasperShowOverlay (event) {
        this.disconnected = false;
        if ( event.detail.message ) {
          this.description = event.detail.message;
        }
        if ( event.detail.spinner === true ) {
          this.$.spinner.style.display = 'flex';
        } else {
          this.$.spinner.style.display = 'none';
        }
        if ( event.detail.icon  ) {
          let icon = event.detail.icon;
          if ( icon.indexOf('/') === -1 ) {
            this.$.image.src = this.resolveUrl('icons/'+icon+'.svg');
          } else {
            this.$.image.src = icon;
          }
        } else {
          this.$.image.src = this.resolveUrl('icons/default.svg');
        }
        this.visible = true;
      }

      _updateVisible (newValue, oldValue) {
        if ( newValue === false ) {
          this.style.opacity = 0.0;
          this.close();
          if ( this._visibilityTimer ) {
            clearTimeout(this._visibilityTimer);
            this._visibilityTimer = undefined;
          }
          return;
        } else {
          this.open();
          this._visibilityTimer = setTimeout(() => this._makeVisible(), 100);
        }
      }

      _makeVisible () {
        this.style.opacity = 0.7;
      }

      _moveHandler (event) {
        this._reconnect();
      }

      _mouseUpHandler (event) {
        this._reconnect();
        this._onCloseByUser();
      }

      _onCloseByUser (event) {
        console.log(event);
        if ( this._disconnected == false && this._connecting == false ) {
          this.visible = false; 
        }
      }

      _reconnect () {
        if ( this._disconnected && this._connecting == false ) {
          this._connecting = true;
          this._disconnected = false;
          this.socket.validateSession();
          this._onCasperShowOverlay({ 
            detail: {
              message: 'i18n_connecting_to_server',
              spinner: true,
              icon: 'connecting'
            }
          });
        }
      }

    }

    window.customElements.define(CasperServerOverlay.is, CasperServerOverlay);
  </script>
</dom-module>
