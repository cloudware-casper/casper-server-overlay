<!--
  - Copyright (c) 2017 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-server-overlay.
  -
  - casper-server-overlay is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-server-overlay  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-server-overlay.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->
<link rel="import" href="../polymer/polymer-element.html">
<!--link rel="import" href="../polymer/lib/utils/resolve-url.html"-->
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">

<dom-module id="casper-server-overlay">
  <template>
    <style>

      :host {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: black;
        width: 100%;
        height: 100vh;
        opacity: 0;
        transition: opacity 3s;
        z-index: 8000;
        fill: white;
      }

      .spinner {
        position: relative;
        width: 250px;
        height: 250px;
      }

      svg {
        position: absolute;
        top: 50px;
        left: 50px;
      }

      #image {
        position: absolute;
        width: 250px;
        height: 250px;
        top: 0;
        left: 0;
      }

      p {
        text-align: center;
        color: #D8D8D8;
        font-size: 1.5em;
        line-height: 1.5em;
      }
    </style>
    <div class="spinner" on-tap="_try_reConnection">
      <img id="image" alt="[[description]]">
      <svg id="spinner" width="150px" height="150px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" >
        <g transform="rotate(0 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.9166666666666666s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(30 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.8333333333333334s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(60 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(90 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.6666666666666666s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(120 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.5833333333333334s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(150 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.5s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(180 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.4166666666666667s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(210 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.3333333333333333s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(240 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.25s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(270 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.16666666666666666s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(300 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="-0.08333333333333333s" repeatCount="indefinite"/>
          </rect>
        </g>
        <g transform="rotate(330 50 50)">
          <rect x="47" y="24" rx="9.4" ry="4.8" width="6" height="12">
            <animate attributeName="opacity" values="1;0" times="0;1" dur="1s" begin="0s" repeatCount="indefinite"/>
          </rect>
        </g>
      </svg>
    </div>
    <p>[[description]]</p>
  </template>

  <script>
    /**
     * `casper-server-overlay`
     * Modal overlay that blocks the UI during server interstatuss
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperServerOverlay extends Polymer.mixinBehaviors([Polymer.IronOverlayBehavior], Polymer.Element) {
      static get is () {
        return 'casper-server-overlay';
      }

      static get properties () {
        return {
          description: String,
          icon: Object,
          status: {
            type: String,
            observer: '_updateStatus'
          }
        };
      }

      ready () {
        super.ready();
        this._visibilityTimer = undefined;
        this.$.spinner.style.display = 'none';
        window.addEventListener('casper-show-overlay', e => this._onCasperShowOverlay(e));
        window.addEventListener('casper-connected', e => this._onCasperConnected(e));
        window.addEventListener('casper-disconnected', e => this._onCasperShowOverlay(e));
        window.addEventListener('casper-signed-in', e => this._onCasperSignedIn(e));

        // // Companies Listeners
        // window.addEventListener('loading-companies', e => this._onCasperShowOverlay(e));
        // window.addEventListener('error-loading-companies', e => this._onCasperShowOverlay(e));
        // window.addEventListener('finished-loading-companies', e => this._onCasperSignedIn(e));

        // Resource Listeners
        window.addEventListener('loading-resource',          e => this._onResourceLoading(e));
        window.addEventListener('error-loading-resource',    e => this._onResourceLoading(e));
        window.addEventListener('finished-loading-resource', e => this._onResourceFinished(e));

      }


      _onResourceLoading(e) {
        this._onCasperShowOverlay(e);
      }

      _onResourceFinished(e) {
        this._onCasperSignedIn(e);
      }



      connectedCallback () {
        super.connectedCallback();
      }

      disconnectedCallback () {
        super.disconnectedCallback();
        if ( this._visibilityTimer ) {
          cancelInterval(this._visibilityTimer);
        }
      }

      _onCasperShowOverlay (event) {
        this.status = 'loading-page';
        if ( event.detail.message ) {
          this.description = event.detail.message; // TODO Já vem traduzida??
        }
        if ( event.detail.spinner === true ) {
          this.$.spinner.style.display = 'flex';
        } else {
          this.$.spinner.style.display = 'none';
        }
        if ( event.detail.icon  ) {
          let icon = event.detail.icon;
          if ( icon.indexOf('/') === -1 ) {
            this.$.image.src = this.resolveUrl('icons/'+icon+'.svg');
          } else {
            this.$.image.src = icon;
          }
        } else {
          this.$.image.src = this.resolveUrl('icons/default.svg');
        }
      }

      _onCasperConnected (event) {
        this.status = 'online';
      }

      // _onCasperDisconnected (event) {
      //   this.$.image.src = this.resolveUrl('icons/no-connection.svg');
      //   this.$.spinner.style.display = 'none';
      //   this.description = ev;
      // }

      _updateOnlineStatus (event){
        this.status = event.type;
        this.currentStatus();
      }


      _updateStatus (newValue, oldValue) {

        if ( this.status === 'online' ) {
          this.style.opacity = 0.0;
          this.close();
          return;
        }
        /*switch (this.status) {
          case 'offline':
            this.icon        = '/static/no-connection@2x.png';
            this.description = "Network: Offline - Por favor verifque a sua ligação a internet";
            break;
          case 'socket-disconnect':
            this.icon        = '/static/no-connection@2x.png';
            this.description = "Sem ligação (C) - Por favor verifque a sua ligação a internet";
            break;
          case 'no-connection':
            this.icon        = '/static/no-connection@2x.png';
            this.description = "Sem ligação - Por favor verifque a sua ligação a internet";
            break;
          case 'connected-to-host':
            this.icon        = '/static/connected-to-host@2x.png';
            this.description = "A establecer a ligação com o servidor";
            break;
          case 'loading-page':
            this.icon        = '/static/loading-page@2x.png';
            this.description = "A carregar a página";
            break;
          default:
        }*/
        this.$.image.src = this.resolveUrl('icons/loading-page.svg');
        this.open();
        this._visibilityTimer = setTimeout(() => this._makeVisible(), 100);
      }

      _makeVisible () {
        console.log("_makeVisible", this.status);
        this.style.opacity = 0.7;
      }

      _onCasperSignedIn (event) {
        this.status = 'online';
      }


      _try_reConnection (event) {
        this.socket.connect();
      }

    }

    window.customElements.define(CasperServerOverlay.is, CasperServerOverlay);
  </script>
</dom-module>
